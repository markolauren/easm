{
  "version": "Notebook/1.0",
  "items": [
    {
      "type": 9,
      "content": {
        "version": "KqlParameterItem/1.0",
        "crossComponentResources": [
          "{Workspace}"
        ],
        "parameters": [
          {
            "version": "KqlParameterItem/1.0",
            "name": "DefaultSubscription_Internal",
            "type": 1,
            "isRequired": true,
            "query": "where type =~ 'microsoft.operationalinsights/workspaces'\r\n| take 1\r\n| project subscriptionId",
            "crossComponentResources": [
              "value::selected"
            ],
            "isHiddenWhenLocked": true,
            "queryType": 1,
            "resourceType": "microsoft.resourcegraph/resources",
            "id": "314d02bf-4691-43fa-af59-d67073c8b8fa"
          },
          {
            "id": "e6ded9a1-a83c-4762-938d-5bf8ff3d3d38",
            "version": "KqlParameterItem/1.0",
            "name": "Subscription",
            "type": 6,
            "isRequired": true,
            "multiSelect": true,
            "quote": "'",
            "delimiter": ",",
            "query": "summarize by subscriptionId\r\n| project value = strcat(\"/subscriptions/\", subscriptionId), label = subscriptionId, selected = iff(subscriptionId =~ '{DefaultSubscription_Internal}', true, false)",
            "crossComponentResources": [
              "value::all"
            ],
            "typeSettings": {
              "additionalResourceOptions": [
                "value::all"
              ],
              "showDefault": false
            },
            "queryType": 1,
            "resourceType": "microsoft.resourcegraph/resources",
            "value": [
              "value::all"
            ]
          },
          {
            "id": "e3225ed0-6210-40a1-b2d0-66e42ffa71d6",
            "version": "KqlParameterItem/1.0",
            "name": "Workspace",
            "type": 5,
            "isRequired": true,
            "multiSelect": true,
            "quote": "'",
            "delimiter": ",",
            "query": "resources\r\n| where type =~ 'microsoft.operationalinsights/workspaces'\r\n| order by name asc\r\n| summarize Selected = makelist(id, 10), All = makelist(id, 1000)\r\n| mvexpand All limit 100\r\n| project value = tostring(All), label = tostring(All), selected = iff(Selected contains All, true, false)",
            "crossComponentResources": [
              "{Subscription}"
            ],
            "typeSettings": {
              "additionalResourceOptions": [
                "value::all"
              ],
              "showDefault": false
            },
            "queryType": 1,
            "resourceType": "microsoft.resourcegraph/resources",
            "value": [
              "value::all"
            ]
          },
          {
            "id": "54a49721-8344-4365-996c-c15972b022a8",
            "version": "KqlParameterItem/1.0",
            "name": "workspace_name",
            "label": "EASM Workspace",
            "type": 2,
            "isRequired": true,
            "query": "EasmRisk_CL\r\n| summarize by WorkspaceName_s\r\n| order by WorkspaceName_s asc",
            "crossComponentResources": [
              "{Workspace}"
            ],
            "typeSettings": {
              "additionalResourceOptions": [],
              "showDefault": false
            },
            "timeContext": {
              "durationMs": 2592000000
            },
            "queryType": 0,
            "resourceType": "microsoft.operationalinsights/workspaces",
            "value": ""
          },
          {
            "id": "15b2c181-7397-43c1-900a-28e175ae8a6f",
            "version": "KqlParameterItem/1.0",
            "name": "TimeRange",
            "type": 4,
            "isRequired": true,
            "typeSettings": {
              "selectableValues": [
                {
                  "durationMs": 259200000
                },
                {
                  "durationMs": 604800000
                },
                {
                  "durationMs": 1209600000
                },
                {
                  "durationMs": 2592000000
                },
                {
                  "durationMs": 5184000000
                },
                {
                  "durationMs": 7776000000
                }
              ],
              "allowCustom": true
            },
            "timeContextFromParameter": "TimeRange",
            "value": {
              "durationMs": 7776000000
            }
          }
        ],
        "style": "pills",
        "queryType": 0,
        "resourceType": "microsoft.operationalinsights/workspaces"
      },
      "name": "Parameter Selectors"
    },
    {
      "type": 11,
      "content": {
        "version": "LinkItem/1.0",
        "style": "tabs",
        "tabStyle": "bigger",
        "links": [
          {
            "id": "18c690d7-7cbd-46c1-b677-1f72692d40cd",
            "cellValue": "TAB",
            "linkTarget": "parameter",
            "linkLabel": "All observations",
            "subTarget": "Trends",
            "preText": "Alert rules",
            "style": "link"
          },
          {
            "id": "f88dcf47-af98-4684-9de3-1ee5f48f68fc",
            "cellValue": "TAB",
            "linkTarget": "parameter",
            "linkLabel": "Asset Risk",
            "subTarget": "Assets",
            "style": "link"
          },
          {
            "id": "e5e949fa-fedf-40a2-9cf9-c826cde3606f",
            "cellValue": "TAB",
            "linkTarget": "parameter",
            "linkLabel": "Vulnerabilities & Exploits",
            "subTarget": "Vulnerabilities",
            "style": "link"
          },
          {
            "id": "83adab4f-c103-4634-bf87-1df21fdffeba",
            "cellValue": "TAB",
            "linkTarget": "parameter",
            "linkLabel": "Snapshot Browser",
            "subTarget": "New",
            "style": "link"
          },
          {
            "id": "8b299bf8-f410-49d7-8280-dfe4567ba2be",
            "cellValue": "TAB",
            "linkTarget": "parameter",
            "linkLabel": "Asset Browser",
            "subTarget": "AssetBrowser",
            "style": "link"
          },
          {
            "id": "d1d87794-c4ec-4847-92ef-8f1154ae41c4",
            "cellValue": "TAB",
            "linkTarget": "parameter",
            "linkLabel": "High",
            "subTarget": "High",
            "style": "link"
          },
          {
            "id": "46dca3c1-da61-41ef-bc19-a55e43a6ca46",
            "cellValue": "TAB",
            "linkTarget": "parameter",
            "linkLabel": "Medium",
            "subTarget": "Medium",
            "style": "link"
          },
          {
            "id": "77ba399b-88bf-4596-8373-7fd15f241328",
            "cellValue": "TAB",
            "linkTarget": "parameter",
            "linkLabel": "Low",
            "subTarget": "Low",
            "style": "link"
          }
        ]
      },
      "name": "Tabs link"
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "items": [
          {
            "type": 1,
            "content": {
              "json": "---\r\n## Risk observations (low, medium, high)"
            },
            "name": "text - 4"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//trend of risks in timechart\nlet workspace = '{workspace_name}';\nEasmRisk_CL\n| where WorkspaceName_s in (workspace)\n| summarize Count=count() by CategoryName_s, SnapshotDateTime_t",
              "size": 0,
              "title": "(select severity level to view observations)",
              "timeContextFromParameter": "TimeRange",
              "exportFieldName": "",
              "exportParameterName": "metrics_all",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "timechart",
              "chartSettings": {
                "showLegend": true,
                "seriesLabelSettings": [
                  {
                    "seriesName": "High Severity",
                    "label": "High Severity",
                    "color": "redBright"
                  },
                  {
                    "seriesName": "Low Severity",
                    "label": "Low Severity",
                    "color": "yellow"
                  },
                  {
                    "seriesName": "Medium Severity",
                    "label": "Medium Severity",
                    "color": "orange"
                  }
                ],
                "ySettings": {
                  "min": 0
                }
              }
            },
            "name": "Risk Findings overall"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "let metric_ = dynamic({metrics_all});\r\nlet workspace = '{workspace_name}';\r\nEasmRisk_CL\r\n| where WorkspaceName_s in (workspace)\r\n| extend test = parse_json(tostring(metric_)).series\r\n| where CategoryName_s == test\r\n| summarize AssetCount=count() by SnapshotDateTime_t, CategoryName_s, MetricDisplayName_s\r\n| sort by SnapshotDateTime_t desc\r\n",
              "size": 1,
              "title": "(select observation to view affected assets)",
              "timeContextFromParameter": "TimeRange",
              "exportParameterName": "observation",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "table",
              "gridSettings": {
                "sortBy": [
                  {
                    "itemKey": "SnapshotDateTime_t",
                    "sortOrder": 2
                  }
                ]
              },
              "sortBy": [
                {
                  "itemKey": "SnapshotDateTime_t",
                  "sortOrder": 2
                }
              ]
            },
            "customWidth": "50",
            "name": "All - data1"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "let observation_ = dynamic({observation});\r\nlet workspace = '{workspace_name}';\r\nEasmRisk_CL\r\n| where WorkspaceName_s in (workspace)\r\n| extend metric = parse_json(tostring(observation_)).MetricDisplayName_s\r\n| extend snaptime = todatetime(observation_.SnapshotDateTime_t)\r\n| where SnapshotDateTime_t == snaptime\r\n| where MetricDisplayName_s == metric\r\n| project AssetName_s, AssetDescription_s//, SnapshotDateTime_t, MetricDisplayName_s\r\n",
              "size": 1,
              "title": "(select asset to view all related observations)",
              "timeContextFromParameter": "TimeRange",
              "exportParameterName": "asset1",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ]
            },
            "customWidth": "50",
            "name": "query - 3"
          },
          {
            "type": 1,
            "content": {
              "json": "---\r\n### Asset observation history"
            },
            "name": "text - 6"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "let asset1_ = dynamic({asset1});\r\nlet workspace = '{workspace_name}';\r\nEasmRisk_CL\r\n| where WorkspaceName_s in (workspace)\r\n| extend test = parse_json(tostring(asset1_)).AssetName_s\r\n| where AssetName_s == test\r\n| summarize Count=count() by MetricDisplayName_s, SnapshotDateTime_t\r\n",
              "size": 1,
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "areachart",
              "chartSettings": {
                "showMetrics": false,
                "showLegend": true
              }
            },
            "customWidth": "50",
            "name": "query - 4"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "let asset1_ = dynamic({asset1});\r\nlet workspace = '{workspace_name}';\r\nEasmRisk_CL\r\n| where WorkspaceName_s in (workspace)\r\n| extend test = parse_json(tostring(asset1_)).AssetName_s\r\n| where AssetName_s == test\r\n| summarize by SnapshotDateTime_t, MetricDisplayName_s\r\n| sort by SnapshotDateTime_t desc",
              "size": 1,
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "table",
              "sortBy": []
            },
            "customWidth": "50",
            "name": "query - 5"
          }
        ]
      },
      "conditionalVisibility": {
        "parameterName": "TAB",
        "comparison": "isEqualTo",
        "value": "Trends"
      },
      "name": "Risk findings",
      "styleSettings": {
        "showBorder": true
      }
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "items": [
          {
            "type": 1,
            "content": {
              "json": "---\r\n## Vulnerabilities"
            },
            "name": "text - 4"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// make a table from https://www.cisa.gov/known-exploited-vulnerabilities-catalog\nlet CISA_NEV = (externaldata(CveId:string,vendorProject:string,product:string,vulnerabilityName:string,dateAdded:string,shortDescription:string,requiredAction:string,dueDate:datetime)\n[@\"https://www.cisa.gov/sites/default/files/csv/known_exploited_vulnerabilities.csv\"] \nwith (format=\"csv\",ignoreFirstRecord=true));\nlet CISA_NEV_CveIDs= CISA_NEV | project CveId;  // make a list from CVEs column\nlet workspace = '{workspace_name}';\nEasmAssetWebComponent_CL\n| where WorkspaceName_s in (workspace)\n| where WebComponentCves_s <> \"[]\"\n| extend vulns = parse_json(WebComponentCves_s)\n| mv-expand vulns\n| extend cve = tostring(vulns.Cve)\n| extend cvss3 = toint(vulns.Cvss3Score)\n| project SnapshotDateTime_t, AssetName_s, WebComponentName_s, WebComponentVersion_s, cve, cvss3, WebComponentLastSeen_t, WorkspaceName_s\n// join with assets' last seen date (show only \"recent\" web components).\n| join kind=leftsemi (EasmAsset_CL\n    | project AssetName_s, AssetLastSeen_t)\n    on $left.WebComponentLastSeen_t == $right.AssetLastSeen_t\n| extend exploit_available = iff(cve in (CISA_NEV_CveIDs), \"yes\", \"no\")\n| join kind=fullouter CISA_NEV on $left.cve == $right.CveId  // Join table of CVEs on devices to CISA NEV table\n| where AssetName_s <> \"\"\n| summarize by AssetName_s, WebComponentName_s, WebComponentVersion_s, cve, cvss3, exploit_available, vendorProject, product, vulnerabilityName, dateAdded, shortDescription, requiredAction\n| summarize count() by exploit_available\n\n",
              "size": 0,
              "title": "Exploit available",
              "timeContextFromParameter": "TimeRange",
              "exportFieldName": "",
              "exportParameterName": "exploit",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "piechart",
              "sortBy": [],
              "tileSettings": {
                "showBorder": false,
                "titleContent": {
                  "columnMatch": "AssetName_s",
                  "formatter": 1
                },
                "leftContent": {
                  "columnMatch": "count_",
                  "formatter": 12,
                  "formatOptions": {
                    "palette": "auto"
                  },
                  "numberFormat": {
                    "unit": 17,
                    "options": {
                      "maximumSignificantDigits": 3,
                      "maximumFractionDigits": 2
                    }
                  }
                }
              },
              "graphSettings": {
                "type": 0,
                "topContent": {
                  "columnMatch": "AssetName_s",
                  "formatter": 1
                },
                "centerContent": {
                  "columnMatch": "count_",
                  "formatter": 1,
                  "numberFormat": {
                    "unit": 17,
                    "options": {
                      "maximumSignificantDigits": 3,
                      "maximumFractionDigits": 2
                    }
                  }
                }
              },
              "chartSettings": {
                "showMetrics": false,
                "showLegend": true,
                "seriesLabelSettings": [
                  {
                    "seriesName": "no",
                    "label": "No",
                    "color": "blue"
                  },
                  {
                    "seriesName": "yes",
                    "label": "Yes",
                    "color": "redBright"
                  }
                ],
                "ySettings": {
                  "min": 0
                }
              }
            },
            "customWidth": "30",
            "name": "Risk Findings overall"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "let exploit_ = dynamic({exploit});\r\n// make a table from https://www.cisa.gov/known-exploited-vulnerabilities-catalog\r\nlet CISA_NEV = (externaldata(CveId:string,vendorProject:string,product:string,vulnerabilityName:string,dateAdded:string,shortDescription:string,requiredAction:string,dueDate:datetime)\r\n[@\"https://www.cisa.gov/sites/default/files/csv/known_exploited_vulnerabilities.csv\"] \r\nwith (format=\"csv\",ignoreFirstRecord=true));\r\nlet CISA_NEV_CveIDs= CISA_NEV | project CveId;  // make a list from CVEs column\r\nlet workspace = '{workspace_name}';\r\nEasmAssetWebComponent_CL\r\n| where WorkspaceName_s in (workspace)| extend test = parse_json(tostring(exploit_)).series\r\n| where WebComponentCves_s <> \"[]\"\r\n| extend vulns = parse_json(WebComponentCves_s)\r\n| mv-expand vulns\r\n| extend cve = tostring(vulns.Cve)\r\n| extend cvss3 = round(todouble(vulns.Cvss3Score),2)\r\n| project SnapshotDateTime_t, AssetName_s, WebComponentName_s, WebComponentVersion_s, cve, cvss3, WebComponentLastSeen_t, WorkspaceName_s, test\r\n// join with assets' last seen date (show only \"recent\" web components).\r\n| join kind=leftsemi (EasmAsset_CL\r\n    | project AssetName_s, AssetLastSeen_t)\r\n    on $left.WebComponentLastSeen_t == $right.AssetLastSeen_t\r\n| extend exploit_available = iff(cve in (CISA_NEV_CveIDs), \"yes\", \"no\")\r\n| where exploit_available == test\r\n| join kind=fullouter CISA_NEV on $left.cve == $right.CveId  // Join table of CVEs on devices to CISA NEV table\r\n| where AssetName_s <> \"\"\r\n| summarize by Asset=AssetName_s, Component=WebComponentName_s, Version=WebComponentVersion_s, CVE=cve, CVSS3=cvss3, Exploit=exploit_available, Vendor=vendorProject, Product=product, Vulnerability=vulnerabilityName, Description=shortDescription\r\n| order by CVSS3 desc",
              "size": 0,
              "timeContextFromParameter": "TimeRange",
              "exportFieldName": "Asset",
              "exportParameterName": "assetname",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "table",
              "sortBy": []
            },
            "customWidth": "70",
            "name": "All - data1"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "let asset_ = '{assetname}';\r\nlet workspace = '{workspace_name}';\r\nEasmRisk_CL\r\n| where WorkspaceName_s in (workspace)\r\n| where AssetName_s == asset_\r\n| project CategoryName_s, MetricDisplayName_s, SnapshotDateTime_t\r\n| order by SnapshotDateTime_t desc",
              "size": 0,
              "title": "Asset's Risk Observations over time",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ]
            },
            "customWidth": "50",
            "name": "query - 3"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "let asset_ = '{assetname}';\r\nlet workspace = '{workspace_name}';\r\nEasmAssetWebComponent_CL\r\n| where WorkspaceName_s in (workspace)\r\n| where AssetName_s == asset_\r\n//| extend test = parse_json(tostring(exploit_)).series\r\n| where WebComponentCves_s <> \"[]\"\r\n| extend vulns = parse_json(WebComponentCves_s)\r\n| mv-expand vulns\r\n| extend cve = tostring(vulns.Cve)\r\n| extend cvss3 = round(todouble(vulns.Cvss3Score),2)\r\n| project SnapshotDateTime_t, AssetName_s, WebComponentName_s, WebComponentVersion_s, cve, cvss3, WebComponentLastSeen_t, WorkspaceName_s\r\n// join with assets' last seen date (show only \"recent\" web components).\r\n| join kind=leftsemi (EasmAsset_CL\r\n    | project AssetName_s, AssetLastSeen_t)\r\n    on $left.WebComponentLastSeen_t == $right.AssetLastSeen_t\r\n| summarize by Component=WebComponentName_s, Version=WebComponentVersion_s, CVE=cve, CVSS3=cvss3\r\n| order by CVSS3 desc",
              "size": 0,
              "title": "Asset's All Vulnerabilities",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ]
            },
            "customWidth": "50",
            "name": "query - 4"
          }
        ]
      },
      "conditionalVisibility": {
        "parameterName": "TAB",
        "comparison": "isEqualTo",
        "value": "Vulnerabilities"
      },
      "name": "Vulns",
      "styleSettings": {
        "showBorder": true
      }
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "items": [
          {
            "type": 1,
            "content": {
              "json": "---\r\nHigh Severity observations\r\n---\r\n(select observation to view affected assets)"
            },
            "name": "text - 3"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "let workspace = '{workspace_name}';\nEasmRisk_CL\n| where WorkspaceName_s in (workspace)\n| where CategoryName_s == \"High Severity\"\n| summarize Count=count() by MetricDisplayName_s, SnapshotDateTime_t\n| render timechart ",
              "size": 0,
              "timeContextFromParameter": "TimeRange",
              "exportParameterName": "metrics_high",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "timechart",
              "chartSettings": {
                "showLegend": true,
                "ySettings": {
                  "min": 0
                }
              }
            },
            "name": "High graph"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "let metric_ = dynamic({metrics_high});\r\nlet workspace = '{workspace_name}';\r\nEasmRisk_CL\r\n| where WorkspaceName_s in (workspace)\r\n| where CategoryName_s == \"High Severity\"\r\n| extend test = parse_json(tostring(metric_)).series\r\n| where MetricDisplayName_s == test\r\n| project SnapshotDateTime_t, CategoryName_s, MetricDisplayName_s, AssetName_s, AssetType_s\r\n| sort by SnapshotDateTime_t desc\r\n\r\n",
              "size": 0,
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "table"
            },
            "name": "High data"
          }
        ]
      },
      "conditionalVisibility": {
        "parameterName": "TAB",
        "comparison": "isEqualTo",
        "value": "High"
      },
      "name": "High",
      "styleSettings": {
        "showBorder": true
      }
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "items": [
          {
            "type": 1,
            "content": {
              "json": "---\r\nMedium Severity observations\r\n---\r\n(select observation to view affected assets)"
            },
            "name": "text - 3 - Copy"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "let workspace = '{workspace_name}';\nEasmRisk_CL\n| where WorkspaceName_s in (workspace)\n| where CategoryName_s == \"Medium Severity\"\n| summarize Count=count() by MetricDisplayName_s, SnapshotDateTime_t\n| render timechart ",
              "size": 0,
              "timeContextFromParameter": "TimeRange",
              "exportFieldName": "",
              "exportParameterName": "metrics_med",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "timechart",
              "chartSettings": {
                "showLegend": true,
                "ySettings": {
                  "min": 0
                }
              }
            },
            "name": "Medium graph"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "let metric_ = dynamic({metrics_med});\r\nlet workspace = '{workspace_name}';\r\nEasmRisk_CL\r\n| where WorkspaceName_s in (workspace)\r\n| where CategoryName_s == \"Medium Severity\"\r\n| extend test = parse_json(tostring(metric_)).series\r\n| where MetricDisplayName_s == test\r\n| project SnapshotDateTime_t, CategoryName_s, MetricDisplayName_s, AssetName_s, AssetType_s\r\n| sort by SnapshotDateTime_t desc\r\n",
              "size": 0,
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "table",
              "gridSettings": {
                "sortBy": [
                  {
                    "itemKey": "SnapshotDateTime_t",
                    "sortOrder": 2
                  }
                ]
              },
              "sortBy": [
                {
                  "itemKey": "SnapshotDateTime_t",
                  "sortOrder": 2
                }
              ]
            },
            "name": "Medium data"
          }
        ]
      },
      "conditionalVisibility": {
        "parameterName": "TAB",
        "comparison": "isEqualTo",
        "value": "Medium"
      },
      "name": "Medium",
      "styleSettings": {
        "showBorder": true
      }
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "items": [
          {
            "type": 1,
            "content": {
              "json": "---\r\nLow Severity observations\r\n---\r\n(select observation to view affected assets)"
            },
            "name": "text - 3 - Copy - Copy"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "let workspace = '{workspace_name}';\nEasmRisk_CL\n| where WorkspaceName_s in (workspace)\n| where CategoryName_s == \"Low Severity\"\n| summarize Count=count() by MetricDisplayName_s, SnapshotDateTime_t\n| render timechart ",
              "size": 0,
              "timeContextFromParameter": "TimeRange",
              "exportParameterName": "metrics_low",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "timechart",
              "chartSettings": {
                "showLegend": true,
                "ySettings": {
                  "min": 0
                }
              }
            },
            "name": "Low graph"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "let metric_ = dynamic({metrics_low});\r\nlet workspace = '{workspace_name}';\r\nEasmRisk_CL\r\n| where WorkspaceName_s in (workspace)\r\n| where CategoryName_s == \"Low Severity\"\r\n| extend test = parse_json(tostring(metric_)).series\r\n| where MetricDisplayName_s == test\r\n| project SnapshotDateTime_t, CategoryName_s, MetricDisplayName_s, AssetName_s, AssetType_s\r\n| sort by SnapshotDateTime_t desc\r\n",
              "size": 0,
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "table",
              "gridSettings": {
                "sortBy": [
                  {
                    "itemKey": "SnapshotDateTime_t",
                    "sortOrder": 2
                  }
                ]
              },
              "sortBy": [
                {
                  "itemKey": "SnapshotDateTime_t",
                  "sortOrder": 2
                }
              ]
            },
            "name": "Low data"
          }
        ]
      },
      "conditionalVisibility": {
        "parameterName": "TAB",
        "comparison": "isEqualTo",
        "value": "Low"
      },
      "name": "Low",
      "styleSettings": {
        "showBorder": true
      }
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "items": [
          {
            "type": 1,
            "content": {
              "json": "---\r\n## Assets by Risk - based on latest snapshot\r\n\r\n(Risk Score - high severity = 10pt, medium = 5pt, low = 1pt)"
            },
            "name": "text - 2"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "let workspace = '{workspace_name}';\r\nEasmRisk_CL\r\n| where WorkspaceName_s in (workspace)\r\n| where TimeGenerated > ago(10d) \r\n| summarize by SnapshotDateTime_t\r\n| sort by SnapshotDateTime_t desc \r\n| take 1\r\n| join (EasmRisk_CL)\r\n    on $left.SnapshotDateTime_t == $right.SnapshotDateTime_t\r\n| extend Low = iff(CategoryName_s == \"Low Severity\",1,0)\r\n| extend Medium = iff(CategoryName_s == \"Medium Severity\",1,0)\r\n| extend High = iff(CategoryName_s == \"High Severity\",1,0)\r\n| summarize LowSum=sum(Low), MedSum=sum(Medium), HighSum=sum(High) by AssetName_s, AssetType_s, AssetFirstSeen_t, AssetLastSeen_t\r\n| extend RiskScore = HighSum*10 + MedSum*5 + LowSum\r\n| project RiskScore, AssetName_s, AssetType_s, HighSum, MedSum, LowSum\r\n| sort by RiskScore desc",
              "size": 0,
              "exportParameterName": "assetname",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "table",
              "gridSettings": {
                "sortBy": [
                  {
                    "itemKey": "RiskScore",
                    "sortOrder": 2
                  }
                ]
              },
              "sortBy": [
                {
                  "itemKey": "RiskScore",
                  "sortOrder": 2
                }
              ]
            },
            "customWidth": "50",
            "name": "Assets top"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "let assetname_ = dynamic({assetname});\r\nlet workspace = '{workspace_name}';\r\nEasmRisk_CL\r\n| where WorkspaceName_s in (workspace)\r\n| extend test = parse_json(tostring(assetname_)).AssetName_s\r\n| where AssetName_s == test\r\n| summarize Count=count() by MetricDisplayName_s, SnapshotDateTime_t\r\n",
              "size": 0,
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "areachart",
              "graphSettings": {
                "type": 0,
                "topContent": {
                  "columnMatch": "MetricDisplayName_s",
                  "formatter": 1
                },
                "centerContent": {
                  "columnMatch": "Count",
                  "formatter": 1,
                  "numberFormat": {
                    "unit": 17,
                    "options": {
                      "maximumSignificantDigits": 3,
                      "maximumFractionDigits": 2
                    }
                  }
                }
              },
              "chartSettings": {
                "ySettings": {
                  "min": 0
                }
              }
            },
            "customWidth": "50",
            "name": "query - 9",
            "styleSettings": {
              "margin": "0",
              "padding": "50px"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "let assetname_ = dynamic({assetname});\r\nlet workspace = '{workspace_name}';\r\nEasmRisk_CL\r\n| where WorkspaceName_s in (workspace)\r\n| extend test = parse_json(tostring(assetname_)).AssetName_s\r\n| where AssetName_s == test\r\n| summarize by CategoryName_s, MetricDisplayName_s, AssetType_s, AssetName_s, AssetDescription_s",
              "size": 0,
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "table"
            },
            "name": "query - 3"
          }
        ]
      },
      "conditionalVisibility": {
        "parameterName": "TAB",
        "comparison": "isEqualTo",
        "value": "Assets"
      },
      "name": "Assets",
      "styleSettings": {
        "showBorder": true
      }
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "items": [
          {
            "type": 1,
            "content": {
              "json": "---\r\nSnapshot Browser\r\n---"
            },
            "name": "text - 2"
          },
          {
            "type": 9,
            "content": {
              "version": "KqlParameterItem/1.0",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "parameters": [
                {
                  "id": "e4959c6c-8acb-431f-ac97-27963fe106b2",
                  "version": "KqlParameterItem/1.0",
                  "name": "Snapshot",
                  "type": 2,
                  "isRequired": true,
                  "query": "let workspace = '{workspace_name}';\r\nEasmRisk_CL \r\n| where WorkspaceName_s in (workspace)\r\n| summarize by snap=SnapshotDateTime_t\r\n| order by snap desc",
                  "crossComponentResources": [
                    "{Workspace}"
                  ],
                  "typeSettings": {
                    "additionalResourceOptions": [],
                    "showDefault": false
                  },
                  "timeContext": {
                    "durationMs": 0
                  },
                  "timeContextFromParameter": "TimeRange",
                  "queryType": 0,
                  "resourceType": "microsoft.operationalinsights/workspaces",
                  "value": null,
                  "label": "Choose a Snapshot"
                }
              ],
              "style": "above",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces"
            },
            "name": "parameters - 2"
          },
          {
            "type": 1,
            "content": {
              "json": "---\r\nNew observations in selected snapshot (high, medium, low)\r\n---\r\n(observations not seen before)\r\n"
            },
            "name": "text - 6"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//let lookback1 = 10d;\r\nlet lookback2 = 30d;\r\nlet sev = \"High Severity\";\r\nlet sev2 = \"Medium Severity\";\r\nlet sev3 = \"Low Severity\";\r\nlet workspace = '{workspace_name}';\r\n// find all observations which have been seen only once within timeline (30d)\r\nEasmRisk_CL \r\n| where WorkspaceName_s in (workspace)\r\n| where TimeGenerated > ago(lookback2)\r\n| where SnapshotDateTime_t <= datetime('{Snapshot}')\r\n| where CategoryName_s == sev or CategoryName_s == sev2 or CategoryName_s == sev3\r\n| summarize count() by AssetId_s, MetricDisplayName_s//, SnapshotDateTime_t\r\n| where count_ == 1\r\n// join the rest of the infromation to found assets/observations\r\n| join (EasmRisk_CL)\r\non AssetId_s, MetricDisplayName_s\r\n| where SnapshotDateTime_t == datetime('{Snapshot}')\r\n| project SnapshotDateTime_t, CategoryName_s, MetricDisplayName_s, AssetName_s, AssetDescription_s, AssetType_s, AssetFirstSeen_t, AssetLastSeen_t\r\n| order by CategoryName_s asc\r\n\r\n",
              "size": 1,
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "gridSettings": {
                "sortBy": [
                  {
                    "itemKey": "MetricDisplayName_s",
                    "sortOrder": 1
                  }
                ]
              },
              "sortBy": [
                {
                  "itemKey": "MetricDisplayName_s",
                  "sortOrder": 1
                }
              ]
            },
            "name": "query - 10"
          },
          {
            "type": 1,
            "content": {
              "json": "---\r\nAll observations in selected snapshot (high, medium, low)\r\n---"
            },
            "name": "text - 6 - Copy"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "let workspace = '{workspace_name}';\r\nEasmRisk_CL \r\n| where WorkspaceName_s in (workspace)\r\n| where SnapshotDateTime_t == datetime('{Snapshot}')\r\n| where CategoryName_s == \"High Severity\"\r\n//| extend Priority = 'High'\r\n//| project Priority, MetricDisplayName_s, AssetName_s\r\n| summarize Count=count() by MetricDisplayName_s\r\n| order by Count desc \r\n\r\n",
              "size": 0,
              "title": "HIGH",
              "timeContextFromParameter": "TimeRange",
              "exportFieldName": "MetricDisplayName_s",
              "exportParameterName": "_high",
              "exportDefaultValue": "empty",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ]
            },
            "customWidth": "33",
            "name": "query - 3",
            "styleSettings": {
              "showBorder": true
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "let workspace = '{workspace_name}';\r\nEasmRisk_CL \r\n| where WorkspaceName_s in (workspace)\r\n| where SnapshotDateTime_t == datetime('{Snapshot}')\r\n| where CategoryName_s == \"Medium Severity\"\r\n//| extend Priority = 'High'\r\n//| project Priority, MetricDisplayName_s, AssetName_s\r\n| summarize Count=count() by MetricDisplayName_s\r\n| order by Count desc \r\n\r\n",
              "size": 0,
              "title": "MEDIUM",
              "timeContextFromParameter": "TimeRange",
              "exportFieldName": "MetricDisplayName_s",
              "exportParameterName": "_med",
              "exportDefaultValue": "empty",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ]
            },
            "customWidth": "33",
            "name": "query - 3 - Copy",
            "styleSettings": {
              "showBorder": true
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "let workspace = '{workspace_name}';\r\nEasmRisk_CL \r\n| where WorkspaceName_s in (workspace)\r\n| where SnapshotDateTime_t == datetime('{Snapshot}')\r\n| where CategoryName_s == \"Low Severity\"\r\n//| extend Priority = 'High'\r\n//| project Priority, MetricDisplayName_s, AssetName_s\r\n| summarize Count=count() by MetricDisplayName_s\r\n| order by Count desc \r\n\r\n",
              "size": 0,
              "title": "LOW",
              "timeContextFromParameter": "TimeRange",
              "exportFieldName": "MetricDisplayName_s",
              "exportParameterName": "_low",
              "exportDefaultValue": "empty",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ]
            },
            "customWidth": "33",
            "name": "query - 3 - Copy - Copy",
            "styleSettings": {
              "showBorder": true
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "let high = '{_high}';\r\nlet med = '{_med}';\r\nlet low = '{_low}';\r\nlet workspace = '{workspace_name}';\r\n// find all observations which have been seen only once within timeline (30d)\r\nEasmRisk_CL \r\n| where SnapshotDateTime_t == datetime('{Snapshot}')\r\n| where MetricDisplayName_s in (high, med, low)\r\n| project CategoryName_s,MetricDisplayName_s,AssetName_s,AssetLastSeen_t,AssetDescription_s, SnapshotDateTime_t\r\n| order by CategoryName_s asc\r\n",
              "size": 0,
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ]
            },
            "name": "query - 8"
          }
        ]
      },
      "conditionalVisibility": {
        "parameterName": "TAB",
        "comparison": "isEqualTo",
        "value": "New"
      },
      "name": "New",
      "styleSettings": {
        "showBorder": true
      }
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "items": [
          {
            "type": 1,
            "content": {
              "json": "---\r\nAsset Browser\r\n---"
            },
            "name": "text - 2"
          },
          {
            "type": 9,
            "content": {
              "version": "KqlParameterItem/1.0",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "parameters": [
                {
                  "id": "d0f9b2be-b6c2-42c3-8e4b-527f0e5651f7",
                  "version": "KqlParameterItem/1.0",
                  "name": "AssetSearch",
                  "label": "Asset Search",
                  "type": 1,
                  "isRequired": true,
                  "timeContext": {
                    "durationMs": 7776000000
                  },
                  "timeContextFromParameter": "TimeRange",
                  "value": ""
                },
                {
                  "id": "e4959c6c-8acb-431f-ac97-27963fe106b2",
                  "version": "KqlParameterItem/1.0",
                  "name": "AssetName",
                  "label": "Choose Asset",
                  "type": 2,
                  "isRequired": true,
                  "query": "let workspace = '{workspace_name}';\r\nlet s = ('{AssetSearch}');\r\nEasmAsset_CL \r\n| where WorkspaceName_s in (workspace)\r\n| where AssetName_s contains s\r\n| distinct AssetName_s\r\n",
                  "crossComponentResources": [
                    "{Workspace}"
                  ],
                  "typeSettings": {
                    "additionalResourceOptions": [],
                    "showDefault": false
                  },
                  "timeContext": {
                    "durationMs": 0
                  },
                  "timeContextFromParameter": "TimeRange",
                  "queryType": 0,
                  "resourceType": "microsoft.operationalinsights/workspaces",
                  "value": "www.tammela.fi"
                }
              ],
              "style": "above",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces"
            },
            "name": "parameters - 2"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "let workspace = '{workspace_name}';\r\nEasmAsset_CL\r\n| where WorkspaceName_s in (workspace)\r\n| where AssetName_s == '{AssetName}'\r\n//| summarize Count=count() by MetricDisplayName_s, SnapshotDateTime_t\r\n| project SnapshotDateTime_t, AssetName_s, AssetType_s, AssetFirstSeen_t, AssetLastSeen_t\r\n| order by SnapshotDateTime_t desc\r\n| take 1\r\n",
              "size": 4,
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ]
            },
            "name": "query - 7"
          },
          {
            "type": 1,
            "content": {
              "json": "---\r\nAll observations over time (high, medium, low)\r\n---"
            },
            "name": "text - 6 - Copy"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "let workspace = '{workspace_name}';\r\nEasmRisk_CL\r\n| where WorkspaceName_s in (workspace)\r\n//| where CategoryName_s == \"High Severity\"\r\n| where AssetName_s == '{AssetName}'\r\n| summarize Count=count() by MetricDisplayName_s, SnapshotDateTime_t\r\n",
              "size": 0,
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "areachart"
            },
            "customWidth": "50",
            "name": "query - 8"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "let workspace = '{workspace_name}';\r\nEasmRisk_CL\r\n| where WorkspaceName_s in (workspace)\r\n//| where CategoryName_s == \"High Severity\"\r\n| where AssetName_s == '{AssetName}'\r\n| summarize by CategoryName_s, MetricDisplayName_s, SnapshotDateTime_t\r\n| order by SnapshotDateTime_t desc\r\n",
              "size": 0,
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ]
            },
            "customWidth": "50",
            "name": "query - 4"
          },
          {
            "type": 1,
            "content": {
              "json": "---\r\nVulnerabilities & Exploits\r\n---"
            },
            "name": "text - 6 - Copy - Copy"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "let asset_ = '{AssetName}';\r\n// make a table from https://www.cisa.gov/known-exploited-vulnerabilities-catalog\r\nlet CISA_NEV = (externaldata(CveId:string,vendorProject:string,product:string,vulnerabilityName:string,dateAdded:string,shortDescription:string,requiredAction:string,dueDate:datetime)\r\n[@\"https://www.cisa.gov/sites/default/files/csv/known_exploited_vulnerabilities.csv\"] \r\nwith (format=\"csv\",ignoreFirstRecord=true));\r\nlet CISA_NEV_CveIDs= CISA_NEV | project CveId;  // make a list from CVEs column\r\nlet workspace = '{workspace_name}';\r\nEasmAssetWebComponent_CL\r\n| where AssetName_s == asset_\r\n| where WorkspaceName_s in (workspace)\r\n| where WebComponentCves_s <> \"[]\"\r\n| extend vulns = parse_json(WebComponentCves_s)\r\n| mv-expand vulns\r\n| extend cve = tostring(vulns.Cve)\r\n| extend cvss3 = round(todouble(vulns.Cvss3Score),2)\r\n| project SnapshotDateTime_t, AssetName_s, WebComponentName_s, WebComponentVersion_s, cve, cvss3, WebComponentLastSeen_t, WorkspaceName_s\r\n// join with assets' last seen date (show only \"recent\" web components).\r\n| join kind=leftsemi (EasmAsset_CL\r\n    | project AssetName_s, AssetLastSeen_t)\r\n    on $left.WebComponentLastSeen_t == $right.AssetLastSeen_t\r\n| extend exploit_available = iff(cve in (CISA_NEV_CveIDs), \"yes\", \"no\")\r\n| join kind=fullouter CISA_NEV on $left.cve == $right.CveId  // Join table of CVEs on devices to CISA NEV table\r\n| where AssetName_s <> \"\"\r\n| summarize by Asset=AssetName_s, Component=WebComponentName_s, Version=WebComponentVersion_s, CVE=cve, CVSS3=cvss3, Exploit=exploit_available, Vendor=vendorProject, Product=product, Vulnerability=vulnerabilityName, Description=shortDescription\r\n| order by CVSS3 desc",
              "size": 0,
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ]
            },
            "name": "query - 5"
          }
        ]
      },
      "conditionalVisibility": {
        "parameterName": "TAB",
        "comparison": "isEqualTo",
        "value": "AssetBrowser"
      },
      "name": "New - Copy",
      "styleSettings": {
        "showBorder": true
      }
    }
  ]
}